<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Finanzas Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            color: #4f46e5;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        th, td {
            white-space: nowrap;
        }
        .loading-text {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .pixelate-text {
            filter: blur(5px);
            transition: filter 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="authScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Iniciar Sesión</h1>
            <button id="signInBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Iniciar sesión con Google
            </button>
        </div>
    </div>

    <div id="mainApp" class="hidden flex flex-col flex-grow">
        <header class="bg-white shadow-sm py-4 px-6 flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a6 6 0 00-6 6v1a1 1 0 001 1h4a1 1 0 001-1v-1a6 6 0 00-6-6zM15 9h-2v2h2m-2-2a2 2 0 00-2-2H9m-2 2h2v2h-2m-2-2a2 2 0 00-2 2H3m2 2v2h2v-2m2-2h-2v2h2m-2-2a2 2 0 00-2-2H9" />
                </svg>
                <span class="text-xl font-bold text-gray-800">Finanzas Personales</span>
            </div>
            <div class="flex items-center">
                <span id="userGreeting" class="text-gray-600 text-sm hidden md:block mr-4"></span>
                <button id="signOutBtn" class="text-gray-500 hover:text-red-500 transition duration-300 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m0-10V4m-2 4h4a2 2 0 012 2v2m-2-4h-4a2 2 0 00-2 2v2" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 md:p-6 pb-20 overflow-y-auto">
        
            <div id="dashboard" class="tab-content grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Resumen de Cuentas</h2>
                        <div class="flex items-center">
                            <label for="toggleBalances" class="text-sm text-gray-600 mr-2">Ocultar saldos</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" id="toggleBalances" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>
                    <div id="accountsSummary" class="space-y-4">
                        <p class="text-sm text-gray-500 loading-text">Cargando resumen de cuentas...</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Ingresos vs Gastos</h2>
                    <canvas id="incomeExpenseChart"></canvas>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Gastos por Categoría</h2>
                    <canvas id="expenseCategoryChart"></canvas>
                </div>

                <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Flujo de Caja Anual</h2>
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>

            <div id="transactions" class="tab-content hidden">
                <div id="transactionMain" class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Gestión de Transacciones</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="registerTransactionBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                            Registrar Transacción
                        </button>
                        <button id="viewHistoryBtn" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                            Historial de Transacciones
                        </button>
                    </div>
                </div>

                <div id="transactionMenu" class="bg-white p-6 rounded-lg shadow-sm mb-6 hidden">
                    <button id="backFromTransactionBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Seleccione Tipo de Transacción</h2>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="addIncomeBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Declarar Ingreso
                        </button>
                        <button id="addExpenseBtn" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Declarar Gasto
                        </button>
                        <button id="addTransferBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                            Transferencia entre cuentas
                        </button>
                        <button id="addRecurringBtn" class="bg-yellow-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-yellow-700 transition duration-300">
                            Transacción recurrente
                        </button>
                    </div>
                </div>

                <div id="transactionContent" class="hidden mt-6">
                    <button id="backFromFormBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>

                    <div id="incomeExpenseForm" class="bg-white p-6 rounded-lg shadow-sm hidden">
                        <h3 id="formTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
                        <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <input type="hidden" id="type" name="type" value="">
                            <input type="hidden" id="transactionId" name="transactionId" value="">
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <input type="text" id="description" name="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700">Cantidad (€)</label>
                                <input type="number" id="amount" name="amount" required step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                                <select id="category" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="date" name="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="account" class="block text-sm font-medium text-gray-700">Cuenta</label>
                                <select id="account" name="account" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                    </select>
                            </div>
                            <div>
                                <label for="accountingBook" class="block text-sm font-medium text-gray-700">Contabilidad</label>
                                <select id="accountingBook" name="accountingBook" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                    </select>
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Registrar Transacción
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="transferForm" class="bg-white p-6 rounded-lg shadow-sm hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Registrar Transferencia</h3>
                        <form id="transferFormElem" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="transferFrom" class="block text-sm font-medium text-gray-700">Cuenta de Origen</label>
                                <select id="transferFrom" name="transferFrom" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="transferTo" class="block text-sm font-medium text-gray-700">Cuenta de Destino</label>
                                <select id="transferTo" name="transferTo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="transferAmount" class="block text-sm font-medium text-gray-700">Cantidad (€)</label>
                                <input type="number" id="transferAmount" name="transferAmount" required step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="transferDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="transferDate" name="transferDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="transferAccountingBook" class="block text-sm font-medium text-gray-700">Contabilidad</label>
                                <select id="transferAccountingBook" name="transferAccountingBook" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Registrar Transferencia
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="recurringForm" class="bg-white p-6 rounded-lg shadow-sm hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Registrar Transacción Recurrente</h3>
                        <form id="recurringFormElem" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="recType" class="block text-sm font-medium text-gray-700">Tipo</label>
                                <select id="recType" name="recType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="income">Ingreso</option>
                                    <option value="expense">Gasto</option>
                                </select>
                            </div>
                            <div>
                                <label for="recDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <input type="text" id="recDescription" name="recDescription" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="recAmount" class="block text-sm font-medium text-gray-700">Cantidad (€)</label>
                                <input type="number" id="recAmount" name="recAmount" required step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="recCategory" class="block text-sm font-medium text-gray-700">Categoría</label>
                                <select id="recCategory" name="recCategory" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="recAccount" class="block text-sm font-medium text-gray-700">Cuenta</label>
                                <select id="recAccount" name="recAccount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="recAccountingBook" class="block text-sm font-medium text-gray-700">Contabilidad</label>
                                <select id="recAccountingBook" name="recAccountingBook" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="recFrequency" class="block text-sm font-medium text-gray-700">Frecuencia</label>
                                <select id="recFrequency" name="recFrequency" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="monthly">Mensual</option>
                                    <option value="weekly">Semanal</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                            <div>
                                <label for="recStartDate" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                                <input type="date" id="recStartDate" name="recStartDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Guardar Recurrente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="transactionHistory" class="bg-white p-6 rounded-lg shadow-sm mt-6 hidden">
                    <button id="backFromHistoryBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Historial de Transacciones</h2>

                    <div id="filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4 p-4 border rounded-lg bg-gray-50">
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                            <input type="date" id="filterStartDate" name="filterStartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                            <input type="date" id="filterEndDate" name="filterEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="filterCategory" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="filterCategory" name="filterCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterAccount" class="block text-sm font-medium text-gray-700">Cuenta</label>
                            <select id="filterAccount" name="filterAccount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="flex items-end gap-2">
                            <button id="sortDateBtn" class="w-full bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                                Ordenar ↓
                            </button>
                            <button id="clearFiltersBtn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                                Limpiar
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuenta</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contabilidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 loading-text">Cargando transacciones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="budgets" class="tab-content hidden">
                 </div>

            <div id="broker" class="tab-content hidden">
                </div>

            <div id="profile" class="tab-content hidden">
                </div>

            <div id="settings" class="tab-content hidden">
                 </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg md:hidden">
            </nav>

        <nav class="hidden md:flex justify-center bg-white shadow-sm py-2 px-6">
            </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc, getDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyA2k5hvtCzAxClwmgxuiyiIzSa4UugZLas",
          authDomain: "finance-control-35102.firebaseapp.com",
          projectId: "finance-control-35102",
          storageBucket: "finance-control-35102.firebasestorage.app",
          messagingSenderId: "863606044392",
          appId: "1:863606044392:web:9da74f5606f988b53b3b5d",
          measurementId: "G-582WDX4234"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const authScreen = document.getElementById('authScreen');
        const mainApp = document.getElementById('mainApp');
        const userGreeting = document.getElementById('userGreeting');
        const userPhoto = document.getElementById('userPhoto');
        const displayName = document.getElementById('displayName');
        const emailAddress = document.getElementById('emailAddress');
        const lastSignInTime = document.getElementById('lastSignInTime');
        const submitBtn = document.getElementById('submitBtn');
        const transactionIdField = document.getElementById('transactionId');

        // NUEVO: Referencias a elementos de filtro
        const filterStartDate = document.getElementById('filterStartDate');
        const filterEndDate = document.getElementById('filterEndDate');
        const filterCategory = document.getElementById('filterCategory');
        const filterAccount = document.getElementById('filterAccount');
        const sortDateBtn = document.getElementById('sortDateBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        
        let userId = null;
        let unsubscribeDashboard;
        let unsubscribeBudgets;
        let unsubscribeAssets;
        let unsubscribeSettings;
        let transactionsData = [];
        let dateSortDirection = 'desc'; // 'desc' para más reciente a más antiguo

        const showAuthScreen = () => {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        };

        const showMainApp = (user) => {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            userGreeting.textContent = `Hola, ${user.displayName.split(' ')[0]}`;
            userPhoto.src = user.photoURL || 'https://via.placeholder.com/150';
            displayName.textContent = user.displayName;
            emailAddress.textContent = user.email;
            lastSignInTime.textContent = new Date(user.metadata.lastSignInTime).toLocaleString();
        };

        signInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error signing in with Google:", error);
            }
        });

        signOutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showAuthScreen();
        });

        const getTabs = () => document.querySelectorAll('.tab-content');
        const getTabButtons = () => document.querySelectorAll('.tab-button');

        const showTab = (tabId) => {
            getTabs().forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            getTabButtons().forEach(button => button.classList.remove('active'));
            // Activar botón tanto en móvil como en escritorio
            document.querySelectorAll(`.tab-button[data-tab="${tabId}"]`).forEach(btn => btn.classList.add('active'));
        };

        getTabButtons().forEach(button => {
            button.addEventListener('click', (e) => {
                showTab(e.currentTarget.dataset.tab);
            });
        });

        // Funciones de manejo de datos
        const dbCollections = {
            transactions: "transactions",
            budgets: "budgets",
            assets: "assets",
            userSettings: "userSettings",
            recurringTransactions: "recurringTransactions"
        };
        
        const hideAllTransactionForms = () => {
            document.getElementById('incomeExpenseForm').classList.add('hidden');
            document.getElementById('transferForm').classList.add('hidden');
            document.getElementById('recurringForm').classList.add('hidden');
        };
        
        const resetTransactionForm = () => {
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            transactionIdField.value = '';
            submitBtn.textContent = 'Registrar Transacción';
        };

        const saveTransaction = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                type: form.type.value,
                description: form.description.value,
                amount: parseFloat(form.amount.value),
                category: form.category.value,
                date: new Date(form.date.value),
                account: form.account.value,
                accountingBook: form.accountingBook.value,
                userId: userId,
                createdAt: serverTimestamp()
            };
            try {
                const transactionId = transactionIdField.value;
                if (transactionId) {
                    await updateDoc(doc(db, dbCollections.transactions, transactionId), data);
                    alert("Transacción actualizada con éxito!");
                    document.getElementById('transactionContent').classList.add('hidden');
                    document.getElementById('transactionHistory').classList.remove('hidden');
                } else {
                    await addDoc(collection(db, dbCollections.transactions), data);
                    alert("Transacción registrada con éxito!");
                }
                resetTransactionForm();
                fetchAndRenderTransactions(); // MODIFICADO: Refresca la lista filtrada
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };
        
        const saveTransfer = async (e) => {
            e.preventDefault();
            const form = e.target;
            const transferAmount = parseFloat(form.transferAmount.value);
            const transferDate = new Date(form.transferDate.value);
            const fromAccount = form.transferFrom.value;
            const toAccount = form.transferTo.value;
            const accountingBook = form.transferAccountingBook.value;

            if (fromAccount === toAccount) {
                alert("Las cuentas de origen y destino no pueden ser las mismas.");
                return;
            }

            const transferData = {
                description: `Transferencia de ${fromAccount} a ${toAccount}`,
                amount: transferAmount,
                date: transferDate,
                accountingBook: accountingBook,
                userId: userId,
                createdAt: serverTimestamp()
            };

            const expenseData = { ...transferData, type: 'expense', account: fromAccount, category: 'Transferencia' };
            const incomeData = { ...transferData, type: 'income', account: toAccount, category: 'Transferencia' };

            try {
                await addDoc(collection(db, dbCollections.transactions), expenseData);
                await addDoc(collection(db, dbCollections.transactions), incomeData);
                form.reset();
                document.getElementById('transferDate').valueAsDate = new Date();
                alert("Transferencia registrada con éxito!");
                fetchAndRenderTransactions(); // MODIFICADO: Refresca la lista filtrada
            } catch (e) {
                console.error("Error adding transfer documents: ", e);
            }
        };

        // ... (saveRecurringTransaction, saveBudget, saveAssetBuy, saveAssetSell sin cambios)
        
        const addSetting = async (settingType, value, initialBalance = null) => {
             // ... (función sin cambios)
        };
        
        const deleteSetting = async (settingType, value) => {
             // ... (función sin cambios)
        };
        
        const deleteDocument = async (collectionName, docId) => {
            if (confirm("¿Estás seguro de que quieres eliminar este registro?")) {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    alert("Registro eliminado.");
                    if (collectionName === dbCollections.transactions) {
                        fetchAndRenderTransactions(); // MODIFICADO: Refresca la lista
                    }
                } catch (e) {
                    console.error("Error deleting document: ", e);
                }
            }
        };
        
        const editTransaction = (docId) => {
            // ... (función sin cambios)
        };
        
        // MODIFICADO: Esta función ahora solo renderiza, no obtiene los datos.
        const renderTransactions = (transactions) => {
            transactionsData = transactions.map(d => ({id: d.id, ...d.data()}));
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No se encontraron transacciones con los filtros aplicados.</td></tr>';
                return;
            }
            transactionsData.forEach(data => {
                const docData = data; // Ya tenemos el objeto de datos
                const row = document.createElement('tr');
                row.className = docData.type === 'expense' ? 'bg-red-50' : 'bg-green-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${docData.date ? new Date(docData.date.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${docData.type === 'income' ? 'Ingreso' : 'Gasto'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${docData.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${docData.amount.toFixed(2)} €</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${docData.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${docData.account}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${docData.accountingBook || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 transition duration-300 mr-2" data-id="${docData.id}">Editar</button>
                        <button class="delete-btn text-red-600 hover:text-red-900 transition duration-300" data-id="${docData.id}" data-collection="${dbCollections.transactions}">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    deleteDocument(e.target.dataset.collection, e.target.dataset.id);
                });
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    editTransaction(e.target.dataset.id);
                });
            });
        };

        // NUEVA: Función para obtener y renderizar transacciones con filtros
        const fetchAndRenderTransactions = async () => {
            if (!userId) return;

            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 loading-text">Cargando transacciones...</td></tr>';

            let transactionQuery = query(collection(db, dbCollections.transactions), where("userId", "==", userId));

            // Aplicar filtros
            if (filterStartDate.value) {
                transactionQuery = query(transactionQuery, where("date", ">=", new Date(filterStartDate.value)));
            }
            if (filterEndDate.value) {
                // Para incluir el día final, la consulta debe ser hasta el final de ese día.
                const endDate = new Date(filterEndDate.value);
                endDate.setHours(23, 59, 59, 999);
                transactionQuery = query(transactionQuery, where("date", "<=", endDate));
            }
            if (filterCategory.value) {
                transactionQuery = query(transactionQuery, where("category", "==", filterCategory.value));
            }
            if (filterAccount.value) {
                transactionQuery = query(transactionQuery, where("account", "==", filterAccount.value));
            }

            // Aplicar ordenamiento
            transactionQuery = query(transactionQuery, orderBy("date", dateSortDirection));

            try {
                const snapshot = await getDocs(transactionQuery);
                renderTransactions(snapshot.docs);
            } catch (error) {
                console.error("Error al obtener transacciones:", error);
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-red-500">Error al cargar transacciones. Revisa la consola para más detalles (puede que falte un índice en Firestore).</td></tr>';
            }
        };

        const renderBudgets = (budgets, transactions) => {
            // ... (función sin cambios)
        };

        const renderPortfolio = async () => {
             // ... (función sin cambios)
        };
        
        const populateSelectOptions = (selectId, options, includePlaceholder = true, placeholderText = 'Seleccionar...') => {
            const selectElem = document.getElementById(selectId);
            selectElem.innerHTML = '';
            if (includePlaceholder) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = placeholderText;
                selectElem.appendChild(placeholder);
            }
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElem.appendChild(option);
            });
        };

        const renderSettings = (settings) => {
             // ... (código de renderList sin cambios)

            // Populate selects in other tabs
            populateSelectOptions('category', settings.categories.filter(c => c !== 'Transferencia' && c !== 'Saldo Inicial'));
            populateSelectOptions('recCategory', settings.categories.filter(c => c !== 'Transferencia' && c !== 'Saldo Inicial'));
            populateSelectOptions('budgetCategory', settings.categories.filter(c => c !== 'Transferencia' && c !== 'Saldo Inicial'));
            populateSelectOptions('account', settings.accounts);
            populateSelectOptions('recAccount', settings.accounts);
            populateSelectOptions('transferFrom', settings.accounts);
            populateSelectOptions('transferTo', settings.accounts);
            populateSelectOptions('accountingBook', settings.accountingBooks);
            populateSelectOptions('recAccountingBook', settings.accountingBooks);
            populateSelectOptions('transferAccountingBook', settings.accountingBooks);

            // NUEVO: Popular los nuevos select de filtros
            populateSelectOptions('filterCategory', settings.categories, true, 'Todas');
            populateSelectOptions('filterAccount', settings.accounts, true, 'Todas');
        };

        const setupRealtimeListeners = (uid) => {
            // MODIFICADO: El listener de transacciones ahora es solo para el dashboard.
            unsubscribeDashboard = onSnapshot(query(collection(db, dbCollections.transactions), where("userId", "==", uid)), (snapshot) => {
                const transactions = snapshot.docs;
                // No llamamos a renderTransactions aquí para no interferir con los filtros
                renderDashboard(transactions);
            });

            unsubscribeBudgets = onSnapshot(query(collection(db, dbCollections.budgets), where("userId", "==", uid)), (snapshot) => {
                const budgets = snapshot.docs;
                const transactionsQuery = query(collection(db, dbCollections.transactions), where("userId", "==", uid));
                getDocs(transactionsQuery).then(transactionsSnapshot => {
                    renderBudgets(budgets, transactionsSnapshot.docs);
                });
            });

            unsubscribeAssets = onSnapshot(query(collection(db, dbCollections.assets), where("userId", "==", uid)), () => {
                renderPortfolio();
            });

            unsubscribeSettings = onSnapshot(doc(db, dbCollections.userSettings, uid), (doc) => {
                if (doc.exists()) {
                    renderSettings(doc.data());
                } else {
                    const defaultSettings = {
                        categories: ["Salario", "Inversiones", "Regalo", "Otros Ingresos", "Alquiler", "Comida", "Transporte", "Ocio", "Facturas", "Salud", "Educación", "Ropa", "Otros Gastos", "Transferencia", "Saldo Inicial"],
                        accounts: ["Efectivo", "Cuenta Bancaria", "Tarjeta de Crédito"],
                        accountingBooks: ["Principal"]
                    };
                    setDoc(doc(db, dbCollections.userSettings, uid), defaultSettings);
                }
            });
        };

        const cleanupRealtimeListeners = () => {
            if (unsubscribeDashboard) unsubscribeDashboard();
            if (unsubscribeBudgets) unsubscribeBudgets();
            if (unsubscribeAssets) unsubscribeAssets();
            if (unsubscribeSettings) unsubscribeSettings();
        };

        // Gráficos y Dashboard
        let incomeExpenseChart, expenseCategoryChart, cashFlowChart;
        const renderDashboard = (transactions) => {
            // ... (funciones de renderizado de dashboard y gráficos sin cambios)
        };

        // Event listeners
        document.getElementById('viewHistoryBtn').addEventListener('click', () => {
            document.getElementById('transactionMain').classList.add('hidden');
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.add('hidden');
            document.getElementById('transactionHistory').classList.remove('hidden');
            fetchAndRenderTransactions(); // Cargar transacciones al mostrar el historial
        });
        
        // ... (otros event listeners de botones sin cambios)

        // NUEVO: Event listeners para los filtros
        filterStartDate.addEventListener('change', fetchAndRenderTransactions);
        filterEndDate.addEventListener('change', fetchAndRenderTransactions);
        filterCategory.addEventListener('change', fetchAndRenderTransactions);
        filterAccount.addEventListener('change', fetchAndRenderTransactions);

        sortDateBtn.addEventListener('click', () => {
            dateSortDirection = dateSortDirection === 'desc' ? 'asc' : 'desc';
            sortDateBtn.textContent = `Ordenar ${dateSortDirection === 'desc' ? '↓' : '↑'}`;
            fetchAndRenderTransactions();
        });

        clearFiltersBtn.addEventListener('click', () => {
            filterStartDate.value = '';
            filterEndDate.value = '';
            filterCategory.value = '';
            filterAccount.value = '';
            dateSortDirection = 'desc';
            sortDateBtn.textContent = 'Ordenar ↓';
            fetchAndRenderTransactions();
        });

        // Inicialización
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('transferDate').valueAsDate = new Date();
        document.getElementById('recStartDate').valueAsDate = new Date();

        const initializeFinancesApp = () => {
             onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    showMainApp(user);
                    setupRealtimeListeners(userId);
                } else {
                    userId = null;
                    cleanupRealtimeListeners();
                    showAuthScreen();
                }
            });
        };

        initializeFinancesApp();

        // ... (código de visibilidad de saldos sin cambios)
    </script>
</body>
</html>
