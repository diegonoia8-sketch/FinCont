<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Finanzas Personales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            color: #4f46e5;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        th, td {
            white-space: nowrap;
        }
        .loading-text {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        .pixelate-text {
            filter: blur(5px);
            transition: filter 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div id="authScreen" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Iniciar Sesión</h1>
            <button id="signInBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                Iniciar sesión con Google
            </button>
        </div>
    </div>

    <div id="mainApp" class="hidden flex flex-col flex-grow">
        <header class="bg-white shadow-sm py-4 px-6 flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a6 6 0 00-6 6v1a1 1 0 001 1h4a1 1 0 001-1v-1a6 6 0 00-6-6zM15 9h-2v2h2m-2-2a2 2 0 00-2-2H9m-2 2h2v2h-2m-2-2a2 2 0 00-2 2H3m2 2v2h2v-2m2-2h-2v2h2m-2-2a2 2 0 00-2-2H9" />
                </svg>
                <span class="text-xl font-bold text-gray-800">Finanzas Personales</span>
            </div>
            <div class="flex items-center">
                <span id="userGreeting" class="text-gray-600 text-sm hidden md:block mr-4"></span>
                <button id="signOutBtn" class="text-gray-500 hover:text-red-500 transition duration-300 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m0-10V4m-2 4h4a2 2 0 012 2v2m-2-4h-4a2 2 0 00-2 2v2" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 md:p-6 pb-20 overflow-y-auto">
    
            <div id="dashboard" class="tab-content grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Resumen de Cuentas</h2>
                        <div class="flex items-center">
                            <label for="toggleBalances" class="text-sm text-gray-600 mr-2">Ocultar saldos</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" value="" id="toggleBalances" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>
                    <div id="accountsSummary" class="space-y-4">
                        <p class="text-sm text-gray-500 loading-text">Cargando resumen de cuentas...</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Ingresos vs Gastos (Mes Actual)</h2>
                    <canvas id="incomeExpenseChart"></canvas>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Análisis por Categoría</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 items-end">
                        <div class="col-span-2 md:col-span-1">
                            <label for="categoryAnalysisType" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="categoryAnalysisType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="expense">Gastos</option>
                                <option value="income">Ingresos</option>
                            </select>
                        </div>
                        <div>
                            <label for="categoryAnalysisStartDate" class="block text-sm font-medium text-gray-700">Inicio</label>
                            <input type="date" id="categoryAnalysisStartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div>
                            <label for="categoryAnalysisEndDate" class="block text-sm font-medium text-gray-700">Fin</label>
                            <input type="date" id="categoryAnalysisEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="col-span-2 md:col-span-4">
                             <button id="updateCategoryChartBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                Actualizar Gráfico
                            </button>
                        </div>
                    </div>
                    <canvas id="categoryAnalysisChart"></canvas>
                </div>
                <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Ahorro Mensual (Últimos 6 Meses)</h2>
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>

            <div id="transactions" class="tab-content hidden">
                <div id="transactionMain" class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Gestión de Transacciones</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="registerTransactionBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                            Registrar Transacción
                        </button>
                        <button id="viewHistoryBtn" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                            Historial de Transacciones
                        </button>
                    </div>
                </div>

                <div id="transactionMenu" class="bg-white p-6 rounded-lg shadow-sm mb-6 hidden">
                    <button id="backFromTransactionBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Seleccione Tipo de Transacción</h2>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="addIncomeBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                            Declarar Ingreso
                        </button>
                        <button id="addExpenseBtn" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                            Declarar Gasto
                        </button>
                        <button id="addTransferBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                            Transferencia entre cuentas
                        </button>
                    </div>
                </div>

                <div id="transactionContent" class="hidden mt-6">
                    <button id="backFromFormBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>

                    <div id="incomeExpenseForm" class="bg-white p-6 rounded-lg shadow-sm hidden">
                        <h3 id="formTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
                        <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <input type="hidden" id="type" name="type" value="">
                            <input type="hidden" id="transactionId" name="transactionId" value="">
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
                                <input type="text" id="description" name="description" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700">Cantidad (€)</label>
                                <input type="number" id="amount" name="amount" required step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                                <select id="category" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="date" name="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="account" class="block text-sm font-medium text-gray-700">Cuenta</label>
                                <select id="account" name="account" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="accountingBook" class="block text-sm font-medium text-gray-700">Contabilidad</label>
                                <select id="accountingBook" name="accountingBook" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Registrar Transacción
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="transferForm" class="bg-white p-6 rounded-lg shadow-sm hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Registrar Transferencia</h3>
                        <form id="transferFormElem" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label for="transferFrom" class="block text-sm font-medium text-gray-700">Cuenta de Origen</label>
                                <select id="transferFrom" name="transferFrom" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="transferTo" class="block text-sm font-medium text-gray-700">Cuenta de Destino</label>
                                <select id="transferTo" name="transferTo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label for="transferAmount" class="block text-sm font-medium text-gray-700">Cantidad (€)</label>
                                <input type="number" id="transferAmount" name="transferAmount" required step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="transferDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="transferDate" name="transferDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="transferAccountingBook" class="block text-sm font-medium text-gray-700">Contabilidad</label>
                                <select id="transferAccountingBook" name="transferAccountingBook" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Registrar Transferencia
                                </button>
                            </div>
                        </form>
                    </div>

                </div>

                <div id="transactionHistory" class="bg-white p-6 rounded-lg shadow-sm mt-6 hidden">
                    <button id="backFromHistoryBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mb-4 hover:bg-gray-400 transition duration-300">
                        &larr; Volver
                    </button>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Historial de Transacciones</h2>

                    <form id="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 p-4 border rounded-lg bg-gray-50 items-end">
                        <div>
                            <label for="filterStartDate" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                            <input type="date" id="filterStartDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="filterEndDate" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                            <input type="date" id="filterEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        </div>
                        <div>
                            <label for="filterCategory" class="block text-sm font-medium text-gray-700">Categoría</label>
                            <select id="filterCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterAccount" class="block text-sm font-medium text-gray-700">Cuenta</label>
                            <select id="filterAccount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterSort" class="block text-sm font-medium text-gray-700">Ordenar por</label>
                            <select id="filterSort" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                                <option value="desc">Más recientes primero</option>
                                <option value="asc">Más antiguas primero</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-2 lg:col-span-5 flex gap-4 mt-2">
                            <button type="button" id="applyFiltersBtn" class="flex-1 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                Aplicar Filtros
                            </button>
                            <button type="button" id="clearFiltersBtn" class="flex-1 bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                                Limpiar
                            </button>
                            <button type="button" id="exportExcelBtn" class="flex-1 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                                Exportar a Excel
                            </button>
                        </div>
                    </form>

                    <div id="historyChartContainer" class="bg-white p-6 rounded-lg shadow-sm mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Análisis de Categorías (Filtrado)</h3>
                        <div class="mb-4 w-full md:w-1/4">
                            <label for="historyChartType" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="historyChartType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="expense">Gastos</option>
                                <option value="income">Ingresos</option>
                            </select>
                        </div>
                        <canvas id="historyChart"></canvas>
                    </div>

                    <div class="table-container">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuenta</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contabilidad</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 loading-text">Cargando transacciones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="settings" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Gestionar Atributos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Categorías</h3>
                            <form id="categoryForm" class="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="newCategory" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Nueva Categoría">
                                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Añadir
                                </button>
                            </form>
                            <div class="flex flex-wrap gap-2" id="categoryList">
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Cuentas</h3>
                            <form id="accountForm" class="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="newAccount" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Nombre de la Cuenta">
                                <input type="number" id="initialBalance" step="0.01" value="0" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Saldo Inicial">
                                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Añadir
                                </button>
                            </form>
                            <div class="flex flex-wrap gap-2" id="accountList">
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Contabilidades</h3>
                            <form id="accountingForm" class="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="newAccountingBook" required class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Nueva Contabilidad">
                                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                    Añadir
                                </button>
                            </form>
                            <div class="flex flex-wrap gap-2" id="accountingList">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg md:hidden">
            <div class="flex justify-around items-center h-16">
                <button id="dashboardBtn" class="tab-button flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600 active" data-tab="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="text-xs mt-1">Inicio</span>
                </button>
                <button id="transactionsBtn" class="tab-button flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600" data-tab="transactions">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a6 6 0 00-6 6v1a1 1 0 001 1h4a1 1 0 001-1v-1a6 6 0 00-6-6zM15 9h-2v2h2m-2-2a2 2 0 00-2-2H9m-2 2h2v2h-2m-2-2a2 2 0 00-2 2H3m2 2v2h2v-2m2-2h-2v2h2m-2-2a2 2 0 00-2-2H9"/>
                    </svg>
                    <span class="text-xs mt-1">Transacciones</span>
                </button>
                <button id="settingsBtn" class="tab-button flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-xs mt-1">Configuración</span>
                </button>
            </div>
        </nav>

        <nav class="hidden md:flex justify-center bg-white shadow-sm py-2 px-6">
            <div class="flex space-x-4">
                <button id="dashboardBtnDesktop" class="tab-button flex items-center p-2 text-gray-500 hover:text-indigo-600 active" data-tab="dashboard">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Inicio</span>
                </button>
                <button id="transactionsBtnDesktop" class="tab-button flex items-center p-2 text-gray-500 hover:text-indigo-600" data-tab="transactions">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a6 6 0 00-6 6v1a1 1 0 001 1h4a1 1 0 001-1v-1a6 6 0 00-6-6zM15 9h-2v2h2m-2-2a2 2 0 00-2-2H9m-2 2h2v2h-2m-2-2a2 2 0 00-2 2H3m2 2v2h2v-2m2-2h-2v2h2m-2-2a2 2 0 00-2-2H9"/>
                    </svg>
                    <span>Transacciones</span>
                </button>
                <button id="settingsBtnDesktop" class="tab-button flex items-center p-2 text-gray-500 hover:text-indigo-600" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span>Configuración</span>
                </button>
            </div>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA2k5hvtCzAxClwmgxuiyiIzSa4UugZLas",
            authDomain: "finance-control-35102.firebaseapp.com",
            projectId: "finance-control-35102",
            storageBucket: "finance-control-35102.firebasestorage.app",
            messagingSenderId: "863606044392",
            appId: "1:863606044392:web:9da74f5606f988b53b3b5d",
            measurementId: "G-582WDX4234"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const authScreen = document.getElementById('authScreen');
        const mainApp = document.getElementById('mainApp');
        const userGreeting = document.getElementById('userGreeting');
        const submitBtn = document.getElementById('submitBtn');
        const transactionIdField = document.getElementById('transactionId');

        let userId = null;
        let unsubscribeTransactions;
        let unsubscribeSettings;

        let allUserTransactions = [];
        
        const showAuthScreen = () => {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
        };
        
        const showMainApp = (user) => {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            userGreeting.textContent = `Hola, ${user.displayName.split(' ')[0]}`;
        };

        signInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error signing in with Google:", error);
            }
        });

        signOutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showAuthScreen();
        });
        
        const getTabs = () => document.querySelectorAll('.tab-content');
        const getTabButtons = () => document.querySelectorAll('.tab-button');
        
        const showTab = (tabId) => {
            getTabs().forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            getTabButtons().forEach(button => button.classList.remove('active'));
            document.querySelectorAll(`.tab-button[data-tab="${tabId}"]`).forEach(btn => btn.classList.add('active'));
        };

        getTabButtons().forEach(button => {
            button.addEventListener('click', (e) => {
                showTab(e.currentTarget.dataset.tab);
            });
        });
        
        const dbCollections = {
            transactions: "transactions",
            userSettings: "userSettings"
        };
        
        const hideAllTransactionForms = () => {
            document.getElementById('incomeExpenseForm').classList.add('hidden');
            document.getElementById('transferForm').classList.add('hidden');
        };
        
        const resetTransactionForm = () => {
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            transactionIdField.value = '';
            submitBtn.textContent = 'Registrar Transacción';
        };
        
        const saveTransaction = async (e) => {
            e.preventDefault();
            const form = e.target;
            const data = {
                type: form.type.value,
                description: form.description.value,
                amount: parseFloat(form.amount.value),
                category: form.category.value,
                date: new Date(form.date.value),
                account: form.account.value,
                accountingBook: form.accountingBook.value,
                userId: userId,
                createdAt: serverTimestamp()
            };
            
            try {
                const transactionId = transactionIdField.value;
                if (transactionId) {
                    await updateDoc(doc(db, dbCollections.transactions, transactionId), data);
                    alert("Transacción actualizada con éxito!");
                    document.getElementById('transactionContent').classList.add('hidden');
                    document.getElementById('transactionHistory').classList.remove('hidden');
                } else {
                    await addDoc(collection(db, dbCollections.transactions), data);
                    alert("Transacción registrada con éxito!");
                }
                resetTransactionForm();
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        };

        const saveTransfer = async (e) => {
            e.preventDefault();
            const form = e.target;
            const transferAmount = parseFloat(form.transferAmount.value);
            const transferDate = new Date(form.transferDate.value);
            const fromAccount = form.transferFrom.value;
            const toAccount = form.transferTo.value;
            const accountingBook = form.transferAccountingBook.value;

            if (fromAccount === toAccount) {
                alert("Las cuentas de origen y destino no pueden ser las mismas.");
                return;
            }

            const transferData = {
                description: `Transferencia de ${fromAccount} a ${toAccount}`,
                amount: transferAmount,
                date: transferDate,
                accountingBook: accountingBook,
                userId: userId,
                createdAt: serverTimestamp()
            };
            
            const expenseData = { ...transferData, type: 'expense', account: fromAccount, category: 'Transferencia' };
            const incomeData = { ...transferData, type: 'income', account: toAccount, category: 'Transferencia' };
            
            try {
                await addDoc(collection(db, dbCollections.transactions), expenseData);
                await addDoc(collection(db, dbCollections.transactions), incomeData);
                form.reset();
                document.getElementById('transferDate').valueAsDate = new Date();
                alert("Transferencia registrada con éxito!");
            } catch (e) {
                console.error("Error adding transfer documents: ", e);
            }
        };

        const addSetting = async (settingType, value, initialBalance = null) => {
            const settingsRef = doc(db, dbCollections.userSettings, userId);
            const settingsDoc = await getDoc(settingsRef);
            let settingsData = {};
            if (settingsDoc.exists()) {
                settingsData = settingsDoc.data();
            } else {
                settingsData = { categories: [], accounts: [], accountingBooks: [] };
            }

            if (!settingsData[settingType]) {
                settingsData[settingType] = [];
            }
            if (!settingsData[settingType].includes(value)) {
                settingsData[settingType].push(value);
                try {
                    await setDoc(settingsRef, { [settingType]: settingsData[settingType] }, { merge: true });
                    alert(`El elemento "${value}" ha sido añadido.`);
                    
                    if (settingType === 'accounts' && initialBalance !== null && parseFloat(initialBalance) > 0) {
                        const transactionData = {
                            type: 'income',
                            description: 'Saldo inicial',
                            amount: parseFloat(initialBalance),
                            category: 'Saldo Inicial',
                            date: new Date(),
                            account: value,
                            accountingBook: 'Principal', 
                            userId: userId,
                            createdAt: serverTimestamp()
                        };
                        await addDoc(collection(db, dbCollections.transactions), transactionData);
                        alert("Saldo inicial registrado como transacción.");
                    }
                } catch (e) {
                    console.error("Error updating settings: ", e);
                }
            } else {
                alert(`El valor "${value}" ya existe.`);
            }
        };
        
        const deleteSetting = async (settingType, value) => {
            if (confirm(`¿Estás seguro de que quieres eliminar "${value}" de ${settingType}?`)) {
                const settingsRef = doc(db, dbCollections.userSettings, userId);
                const settingsDoc = await getDoc(settingsRef);
                const settingsData = settingsDoc.data();
                const newArray = settingsData[settingType].filter(item => item !== value);
                try {
                    await updateDoc(settingsRef, { [settingType]: newArray });
                    alert("Elemento eliminado.");
                } catch (e) {
                    console.error("Error deleting setting: ", e);
                }
            }
        };
        
        const deleteDocument = async (collectionName, docId) => {
            if (confirm("¿Estás seguro de que quieres eliminar este registro?")) {
                try {
                    await deleteDoc(doc(db, collectionName, docId));
                    alert("Registro eliminado.");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                }
            }
        };
        
        const editTransaction = (docId) => {
            const transaction = allUserTransactions.find(t => t.id === docId);
            if (!transaction) return;

            document.getElementById('transactionMain').classList.add('hidden');
            document.getElementById('transactionHistory').classList.add('hidden');
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.remove('hidden');
            hideAllTransactionForms();
            document.getElementById('incomeExpenseForm').classList.remove('hidden');
            
            document.getElementById('formTitle').textContent = 'Editar Transacción';
            submitBtn.textContent = 'Guardar Cambios';
            transactionIdField.value = docId;
            document.getElementById('type').value = transaction.type;
            document.getElementById('description').value = transaction.description;
            document.getElementById('amount').value = transaction.amount;
            document.getElementById('category').value = transaction.category;
            document.getElementById('date').value = new Date(transaction.date.seconds * 1000).toISOString().split('T')[0];
            document.getElementById('account').value = transaction.account;
            document.getElementById('accountingBook').value = transaction.accountingBook;
        };

        const renderTransactionsTable = (transactions) => {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">No hay transacciones que coincidan con los filtros.</td></tr>';
                return;
            }
            transactions.forEach(data => {
                const row = document.createElement('tr');
                row.className = data.type === 'expense' ? 'bg-red-50' : 'bg-green-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${data.type === 'income' ? 'Ingreso' : 'Gasto'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${data.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">${data.amount.toFixed(2)} €</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${data.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${data.account}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${data.accountingBook || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 transition duration-300 mr-2" data-id="${data.id}">
                            Editar
                        </button>
                        <button class="delete-btn text-red-600 hover:text-red-900 transition duration-300" data-id="${data.id}" data-collection="${dbCollections.transactions}">
                            Eliminar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    deleteDocument(e.target.dataset.collection, e.target.dataset.id);
                });
            });
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    editTransaction(e.target.dataset.id);
                });
            });
        };
        
        // *** NUEVA VARIABLE PARA EL GRÁFICO DEL HISTORIAL ***
        let historyChart;

        // *** NUEVA FUNCIÓN PARA RENDERIZAR EL GRÁFICO DEL HISTORIAL ***
        const renderHistoryChart = (transactions) => {
            // Destruir gráfico anterior si existe
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }

            const type = document.getElementById('historyChartType').value;
            
            // Filtrar de nuevo por tipo y excluir categorías especiales
            const filtered = transactions.filter(t => t.type === type && t.category !== 'Transferencia' && t.category !== 'Saldo Inicial');

            const ctx = document.getElementById('historyChart').getContext('2d');

            // Si no hay datos, mostrar mensaje
            if (filtered.length === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.save();
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.fillStyle = '#9CA3AF'; // text-gray-400
                 ctx.font = '16px "Inter", sans-serif';
                 ctx.fillText('No hay datos para esta selección', ctx.canvas.width / 2, ctx.canvas.height / 2);
                 ctx.restore();
                 return;
            }

            // Agregar datos por categoría
            const categories = filtered.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const data = {
                labels: Object.keys(categories),
                datasets: [{
                    data: Object.values(categories),
                    backgroundColor: [
                        '#4c51bf', '#63b3ed', '#4fd1c5', '#f6ad55', '#e53e3e',
                        '#d53f8c', '#a0aec0', '#9f7aea', '#38b2ac', '#ed8936'
                    ],
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: { callbacks: { label: (item) => `${item.label}: ${item.raw.toFixed(2)} €` } }
                    }
                }
            };
            
            historyChart = new Chart(ctx, config);
        };


        // *** FUNCIÓN MODIFICADA: applyFiltersAndRender AHORA TAMBIÉN LLAMA AL NUEVO GRÁFICO ***
        const applyFiltersAndRender = () => {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            const account = document.getElementById('filterAccount').value;
            const sortOrder = document.getElementById('filterSort').value;

            let filteredTransactions = [...allUserTransactions];
            
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filteredTransactions = filteredTransactions.filter(t => t.date.toDate() >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => t.date.toDate() <= end);
            }
            if (category) {
                filteredTransactions = filteredTransactions.filter(t => t.category === category);
            }
            if (account) {
                filteredTransactions = filteredTransactions.filter(t => t.account === account);
            }

            filteredTransactions.sort((a, b) => {
                const dateA = a.date.seconds;
                const dateB = b.date.seconds;
                return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
            });
            
            renderTransactionsTable(filteredTransactions);
            // *** NUEVA LLAMADA A LA FUNCIÓN DEL GRÁFICO ***
            renderHistoryChart(filteredTransactions);
        };
        
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFiltersAndRender);
        
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterForm').reset();
            applyFiltersAndRender();
        });

        // *** NUEVO EVENT LISTENER PARA EL SELECTOR DE TIPO DEL GRÁFICO DEL HISTORIAL ***
        document.getElementById('historyChartType').addEventListener('change', applyFiltersAndRender);

        const exportToCSV = () => {
            // 1. Obtener valores de los filtros
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const category = document.getElementById('filterCategory').value;
            const account = document.getElementById('filterAccount').value;
            const sortOrder = document.getElementById('filterSort').value;

            // 2. Filtrar transacciones
            let filteredTransactions = [...allUserTransactions];
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filteredTransactions = filteredTransactions.filter(t => t.date.toDate() >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredTransactions = filteredTransactions.filter(t => t.date.toDate() <= end);
            }
            if (category) {
                filteredTransactions = filteredTransactions.filter(t => t.category === category);
            }
            if (account) {
                filteredTransactions = filteredTransactions.filter(t => t.account === account);
            }

            // 3. Ordenar transacciones
            filteredTransactions.sort((a, b) => {
                const dateA = a.date.seconds;
                const dateB = b.date.seconds;
                return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
            });

            // 4. Construir el contenido CSV
            const headers = ['Fecha', 'Tipo', 'Descripción', 'Cantidad (€)', 'Categoría', 'Cuenta', 'Contabilidad'];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n';

            filteredTransactions.forEach(t => {
                const date = t.date ? new Date(t.date.seconds * 1000).toLocaleDateString('es-ES') : 'N/A';
                const type = t.type === 'income' ? 'Ingreso' : 'Gasto';
                const description = `"${t.description.replace(/"/g, '""')}"`;
                const amount = t.amount.toFixed(2);
                const cat = t.category || 'N/A';
                const acc = t.account || 'N/A';
                const acctBook = t.accountingBook || 'N/A';

                const row = [date, type, description, amount, cat, acc, acctBook].join(',');
                csvContent += row + '\n';
            });

            // 5. Crear y disparar la descarga
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'historial_transacciones.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        document.getElementById('exportExcelBtn').addEventListener('click', exportToCSV);
        
        const populateSelectOptions = (selectId, options, includePlaceholder = true, placeholderText = 'Seleccionar...') => {
            const selectElem = document.getElementById(selectId);
            if (!selectElem) return; 
            
            selectElem.innerHTML = '';
            if (includePlaceholder) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = placeholderText;
                selectElem.appendChild(placeholder);
            }
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElem.appendChild(option);
            });
        };

        const renderSettings = (settings) => {
            const categoryList = document.getElementById('categoryList');
            const accountList = document.getElementById('accountList');
            const accountingList = document.getElementById('accountingList');

            const renderList = (listElement, items, settingType) => {
                listElement.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2 bg-gray-200 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded-full';
                    div.innerHTML = `
                        <span>${item}</span>
                        <button class="delete-setting-btn text-red-500 hover:text-red-700" data-setting-type="${settingType}" data-value="${item}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    listElement.appendChild(div);
                });
            };
            
            renderList(categoryList, settings.categories, 'categories');
            renderList(accountList, settings.accounts, 'accounts');
            renderList(accountingList, settings.accountingBooks, 'accountingBooks');

            document.querySelectorAll('.delete-setting-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    deleteSetting(e.currentTarget.dataset.settingType, e.currentTarget.dataset.value);
                });
            });
            
            const categoriesForExpenses = settings.categories.filter(c => c !== 'Transferencia' && c !== 'Saldo Inicial');
            populateSelectOptions('category', categoriesForExpenses);
            populateSelectOptions('account', settings.accounts);
            populateSelectOptions('transferFrom', settings.accounts);
            populateSelectOptions('transferTo', settings.accounts);
            populateSelectOptions('accountingBook', settings.accountingBooks);
            populateSelectOptions('transferAccountingBook', settings.accountingBooks);
            
            populateSelectOptions('filterCategory', settings.categories, true, 'Todas las categorías');
            populateSelectOptions('filterAccount', settings.accounts, true, 'Todas las cuentas');
        };


        const setupRealtimeListeners = (uid) => {
            unsubscribeTransactions = onSnapshot(query(collection(db, dbCollections.transactions), where("userId", "==", uid)), (snapshot) => {
                const transactionsFromDB = snapshot.docs;
                allUserTransactions = transactionsFromDB.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Actualiza el dashboard
                renderDashboard(transactionsFromDB);

                // Si el historial está visible, actualiza la tabla y el gráfico
                if (!document.getElementById('transactionHistory').classList.contains('hidden')) {
                    applyFiltersAndRender();
                }
            });

            unsubscribeSettings = onSnapshot(doc(db, dbCollections.userSettings, uid), (doc) => {
                if (doc.exists()) {
                    renderSettings(doc.data());
                } else {
                    const defaultSettings = {
                        categories: ["Salario", "Inversiones", "Regalo", "Otros Ingresos", "Alquiler", "Comida", "Transporte", "Ocio", "Facturas", "Salud", "Educación", "Ropa", "Otros Gastos", "Transferencia", "Saldo Inicial"],
                        accounts: ["Efectivo", "Cuenta Bancaria", "Tarjeta de Crédito"],
                        accountingBooks: ["Principal"]
                    };
                    setDoc(doc(db, dbCollections.userSettings, uid), defaultSettings);
                }
            });
        };

        const cleanupRealtimeListeners = () => {
            if (unsubscribeTransactions) unsubscribeTransactions();
            if (unsubscribeSettings) unsubscribeSettings();
        };
        
        let incomeExpenseChart, categoryAnalysisChart, cashFlowChart;
        
        const renderDashboard = (transactions) => {
            renderAccountsSummary(transactions);
            renderIncomeExpenseChart(transactions);
            renderCategoryAnalysisChart();
            renderCashFlowChart(transactions);
        };

        const toggleBalancesVisibility = (shouldPixelate) => {
            const balanceElements = document.querySelectorAll('.balance-value');
            balanceElements.forEach(element => {
                if (shouldPixelate) {
                    element.classList.add('pixelate-text');
                } else {
                    element.classList.remove('pixelate-text');
                }
            });
        };

        const renderAccountsSummary = (transactions) => {
            const summaryDiv = document.getElementById('accountsSummary');
            const accounts = {};

            transactions.forEach(doc => {
                const data = doc.data();
                if (!accounts[data.account]) accounts[data.account] = 0;

                if (data.type === 'income') {
                    accounts[data.account] += data.amount;
                } else if (data.type === 'expense') {
                    accounts[data.account] -= data.amount;
                }
            });
            
            let html = '';
            let totalBalance = 0;

            for (const account in accounts) {
                totalBalance += accounts[account];
                html += `
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">${account}</span>
                        <span class="balance-value text-sm font-bold ${accounts[account] >= 0 ? 'text-green-600' : 'text-red-600'}">${accounts[account].toFixed(2)} €</span>
                    </div>
                `;
            }

            html += `
                <div class="flex items-center justify-between mt-4 border-t pt-4">
                    <span class="text-base font-semibold text-gray-800">Saldo Total:</span>
                    <span id="totalBalance" class="balance-value text-xl font-bold text-indigo-600">${totalBalance.toFixed(2)} €</span>
                </div>
            `;
            
            summaryDiv.innerHTML = html;
            const isPixelated = document.getElementById('toggleBalances').checked;
            toggleBalancesVisibility(isPixelated);
        };

        const renderIncomeExpenseChart = (transactions) => {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const currentMonthTransactions = transactions.filter(t => {
                const date = t.data().date.toDate();
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const income = currentMonthTransactions
                .filter(t => t.data().type === 'income' && t.data().category !== 'Transferencia' && t.data().category !== 'Saldo Inicial')
                .reduce((sum, t) => sum + t.data().amount, 0);
            const expense = currentMonthTransactions
                .filter(t => t.data().type === 'expense' && t.data().category !== 'Transferencia')
                .reduce((sum, t) => sum + t.data().amount, 0);
                
            const data = {
                labels: ['Ingresos', 'Gastos'],
                datasets: [{
                    data: [income, expense],
                    backgroundColor: ['#4f46e5', '#ef4444']
                }]
            };
            
            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (item) => `${item.label}: ${item.raw.toFixed(2)} €` } }
                    }
                }
            };

            if (incomeExpenseChart) incomeExpenseChart.destroy();
            incomeExpenseChart = new Chart(document.getElementById('incomeExpenseChart'), config);
        };
        
        const renderCategoryAnalysisChart = () => {
            const type = document.getElementById('categoryAnalysisType').value;
            const startDateValue = document.getElementById('categoryAnalysisStartDate').value;
            const endDateValue = document.getElementById('categoryAnalysisEndDate').value;

            let filtered = allUserTransactions.filter(t => t.type === type && t.category !== 'Transferencia' && t.category !== 'Saldo Inicial');
            
            if (startDateValue) {
                const start = new Date(startDateValue);
                start.setHours(0,0,0,0);
                filtered = filtered.filter(t => t.date.toDate() >= start);
            }
            if (endDateValue) {
                const end = new Date(endDateValue);
                end.setHours(23,59,59,999);
                filtered = filtered.filter(t => t.date.toDate() <= end);
            }
            
            const categories = filtered.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});
            
            const data = {
                labels: Object.keys(categories),
                datasets: [{
                    data: Object.values(categories),
                    backgroundColor: [
                        '#4c51bf', '#63b3ed', '#4fd1c5', '#f6ad55', '#e53e3e',
                        '#d53f8c', '#a0aec0', '#9f7aea', '#38b2ac', '#ed8936'
                    ],
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: { callbacks: { label: (item) => `${item.label}: ${item.raw.toFixed(2)} €` } }
                    }
                }
            };

            if (categoryAnalysisChart) categoryAnalysisChart.destroy();
            categoryAnalysisChart = new Chart(document.getElementById('categoryAnalysisChart'), config);
        };

        const renderCashFlowChart = (transactions) => {
            const monthlyData = {};
            const monthLabelsShort = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const today = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                monthlyData[key] = {
                    income: 0,
                    expense: 0,
                    label: monthLabelsShort[d.getMonth()]
                };
            }
            
            const sixMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 5, 1);
            sixMonthsAgo.setHours(0,0,0,0);

            const recentTransactions = transactions.filter(t => t.data().date.toDate() >= sixMonthsAgo);

            recentTransactions.forEach(tDoc => {
                const t = tDoc.data();
                const date = t.date.toDate();
                const key = `${date.getFullYear()}-${date.getMonth()}`;
                if (monthlyData[key]) {
                    if (t.type === 'income' && t.category !== 'Transferencia' && t.category !== 'Saldo Inicial') {
                        monthlyData[key].income += t.amount;
                    } else if (t.type === 'expense' && t.category !== 'Transferencia') {
                        monthlyData[key].expense += t.amount;
                    }
                }
            });
            
            const sortedKeys = Object.keys(monthlyData).sort((a, b) => new Date(a.split('-')[0], a.split('-')[1]) - new Date(b.split('-')[0], b.split('-')[1]));
            
            const labels = sortedKeys.map(key => monthlyData[key].label);
            const savingsData = sortedKeys.map(key => monthlyData[key].income - monthlyData[key].expense);
            const backgroundColors = savingsData.map(saving => saving >= 0 ? 'rgba(79, 70, 229, 0.7)' : 'rgba(239, 68, 68, 0.7)');
            
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Ahorro Mensual',
                    data: savingsData,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            };
            
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Ahorro: ${context.raw.toFixed(2)} €`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (value) => `${value} €`
                            }
                        }
                    }
                }
            };
            
            if (cashFlowChart) cashFlowChart.destroy();
            cashFlowChart = new Chart(document.getElementById('cashFlowChart'), config);
        };

        // Event listeners
        document.getElementById('updateCategoryChartBtn').addEventListener('click', renderCategoryAnalysisChart);
        
        document.getElementById('registerTransactionBtn').addEventListener('click', () => {
            document.getElementById('transactionMain').classList.add('hidden');
            document.getElementById('transactionHistory').classList.add('hidden');
            document.getElementById('transactionMenu').classList.remove('hidden');
        });
        
        // *** MODIFICADO: Llama a applyFiltersAndRender para poblar el gráfico al entrar ***
        document.getElementById('viewHistoryBtn').addEventListener('click', () => {
            document.getElementById('transactionMain').classList.add('hidden');
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.add('hidden');
            document.getElementById('transactionHistory').classList.remove('hidden');
            // Llama a la función para poblar la tabla Y el gráfico al cargar la vista
            applyFiltersAndRender();
        });
        
        document.getElementById('backFromTransactionBtn').addEventListener('click', () => {
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionMain').classList.remove('hidden');
        });
        
        // *** SOLUCIÓN AL BUG: Llamar a hideAllTransactionForms() ***
        document.getElementById('addIncomeBtn').addEventListener('click', () => {
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.remove('hidden');
            hideAllTransactionForms(); // <-- BUG SOLUCIONADO
            document.getElementById('incomeExpenseForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'Registrar Ingreso';
            document.getElementById('type').value = 'income';
            resetTransactionForm();
        });
        
        // *** SOLUCIÓN AL BUG: Llamar a hideAllTransactionForms() ***
        document.getElementById('addExpenseBtn').addEventListener('click', () => {
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.remove('hidden');
            hideAllTransactionForms(); // <-- BUG SOLUCIONADO
            document.getElementById('incomeExpenseForm').classList.remove('hidden');
            document.getElementById('formTitle').textContent = 'Registrar Gasto';
            document.getElementById('type').value = 'expense';
            resetTransactionForm();
        });
        
        // *** MODIFICADO: Llamar a hideAllTransactionForms() por consistencia ***
        document.getElementById('addTransferBtn').addEventListener('click', () => {
            document.getElementById('transactionMenu').classList.add('hidden');
            document.getElementById('transactionContent').classList.remove('hidden');
            hideAllTransactionForms(); // <-- BUG SOLUCIONADO
            document.getElementById('transferForm').classList.remove('hidden');
        });
        
        document.getElementById('backFromFormBtn').addEventListener('click', () => {
            document.getElementById('transactionContent').classList.add('hidden');
            document.getElementById('transactionMenu').classList.remove('hidden');
            resetTransactionForm();
        });
        
        // *** MODIFICADO: Destruye el gráfico del historial al salir ***
        document.getElementById('backFromHistoryBtn').addEventListener('click', () => {
            document.getElementById('transactionHistory').classList.add('hidden');
            document.getElementById('transactionMain').classList.remove('hidden');
            
            // Destruir el gráfico para liberar memoria
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }
        });
        
        document.getElementById('transactionForm').addEventListener('submit', saveTransaction);
        document.getElementById('transferFormElem').addEventListener('submit', saveTransfer);

        document.getElementById('categoryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newCategory = document.getElementById('newCategory').value.trim();
            if (newCategory) {
                addSetting('categories', newCategory);
                document.getElementById('newCategory').value = '';
            }
        });

        document.getElementById('accountForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newAccountName = document.getElementById('newAccount').value.trim();
            const initialBalance = document.getElementById('initialBalance').value;
            if (newAccountName) {
                addSetting('accounts', newAccountName, initialBalance);
                document.getElementById('newAccount').value = '';
                document.getElementById('initialBalance').value = '0';
            }
        });
        
        document.getElementById('accountingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newAccountingBook = document.getElementById('newAccountingBook').value.trim();
            if (newAccountingBook) {
                addSetting('accountingBooks', newAccountingBook);
                document.getElementById('newAccountingBook').value = '';
            }
        });
        
        const initializeFinancesApp = () => {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('categoryAnalysisStartDate').value = firstDay;
            document.getElementById('categoryAnalysisEndDate').value = lastDay;

             onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    showMainApp(user);
                    setupRealtimeListeners(userId);
                } else {
                    userId = null;
                    cleanupRealtimeListeners();
                    showAuthScreen();
                }
            });
        };
        
        const toggleBalancesSwitch = document.getElementById('toggleBalances');
        if (toggleBalancesSwitch) {
            const isPixelated = localStorage.getItem('pixelateBalances') === 'true';
            toggleBalancesSwitch.checked = isPixelated;

            toggleBalancesSwitch.addEventListener('change', () => {
                const isChecked = toggleBalancesSwitch.checked;
                localStorage.setItem('pixelateBalances', isChecked);
                toggleBalancesVisibility(isChecked);
            });
        }
        
        initializeFinancesApp();

    </script>
</body>
</html>
